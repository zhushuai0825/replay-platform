# 9. 测试与 CI（当前状态 + 下一步计划）

> 目前仓库尚未编写任何自动化测试或 CI 配置，本章记录“现状”和“如何按照现有代码补齐”。

---

## 1. 现状概览

- **后端**：`backend/` 下没有 `tests/` 目录，也没有 pytest 相关依赖
- **前端**：`package.json` 中未定义 `test` 脚本，尚未安装 Vitest/Jest 等工具
- **CI/CD**：仓库根目录没有 `.github/workflows/`、`.gitlab-ci.yml` 等文件

因此，任何测试或 CI 指令都会失败，需要按下面步骤逐步补齐。

---

## 2. 后端测试（建议步骤）

1. **安装依赖**  
   新建 `backend/requirements-dev.txt`，内容示例：
   ```
   -r requirements.txt
   pytest==7.4.3
   httpx==0.25.2
   ```
   然后：
   ```bash
   cd backend
   pip install -r requirements-dev.txt
   ```

2. **创建目录结构**
   ```
   backend/tests/
     __init__.py
     test_api/
       test_tasks.py
   ```

3. **示例测试（与当前代码匹配）**
   ```python
   # backend/tests/test_api/test_tasks.py
   """
   由于 tasks 接口依赖真实数据库，这里的示例只验证接口能返回 200，
   并不做数据断言。后续可通过依赖覆盖或临时 SQLite 来完善。
   """

   from fastapi.testclient import TestClient
   from app.main import app

   client = TestClient(app)

   def test_list_tasks_status_code():
       response = client.get("/api/v1/tasks/")
       assert response.status_code == 200
   ```
   > 注意：要让此测试通过，需要先启动 PostgreSQL，并保证 `DATABASE_URL` 可用。

4. **运行测试**
   ```bash
   cd backend
   pytest
   ```

---

## 3. 前端测试（可选）

1. 安装依赖（目前项目未安装）：
   ```bash
   cd frontend
   npm install -D vitest @vue/test-utils jsdom
   ```

2. 在 `package.json` 中新增脚本：
   ```json
   "scripts": {
     "dev": "vite",
     "build": "vite build",
     "preview": "vite preview",
     "test": "vitest run"
   }
   ```

3. 简单示例（针对 `Tasks.vue` 现状）：
   ```javascript
   import { mount } from '@vue/test-utils'
   import Tasks from '@/views/Tasks.vue'

   test('renders tasks placeholder', () => {
     const wrapper = mount(Tasks)
     expect(wrapper.text()).toContain('任务管理')
   })
   ```

4. 运行：
   ```bash
   npm run test
   ```

---

## 4. CI（GitHub Actions 示例草案）

> 当前仓库没有 CI 配置，可在根目录创建 `.github/workflows/ci.yml`，内容与下面示例类似。请根据实际测试情况决定是否启用。

```yaml
name: CI

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements-dev.txt
      - name: Run backend tests
        run: |
          cd backend
          pytest

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install & test
        run: |
          cd frontend
          npm install
          npm run build
          npm run test
```

> 如果暂时没有编写测试，可把相应 job 注释掉或仅保留 `npm run build`、`pip install` 等基础步骤。

---

## 5. lint / format（未来可选）

- **后端**：推荐 `black` + `isort` + `flake8`
  ```bash
  pip install black isort flake8
  black app
  isort app
  flake8 app
  ```
- **前端**：可初始化 ESLint/Prettier
  ```bash
  npm install -D eslint prettier
  npm run lint  # 需在 package.json 中配置
  ```
- 与 CI 结合时，可在 workflow 中增加对应命令，保证提交代码风格一致。

---

## 6. 建议的下一步

1. 先落地后端最小测试（如 `test_list_tasks_status_code`），确认 pytest 能执行
2. 再根据实际业务（任务创建、流量上传）逐步补齐更多断言
3. 同步完善 CI，至少跑 `pytest` 和 `npm run build`
4. 每新增一段关键逻辑，及时补测试，避免回归风险
