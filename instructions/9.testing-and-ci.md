# 9. 测试与 CI（完整示例）

## 1. 后端测试（pytest + TestClient）

### 1.1 开发依赖
在 `backend/requirements-dev.txt` 中添加：
```
-r requirements.txt
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.2
```
安装：`pip install -r requirements-dev.txt`

### 1.2 目录
```
backend/tests/
  __init__.py
  test_api/
    test_tasks.py
```

### 1.3 示例测试
```python
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_list_tasks_empty():
    response = client.get("/api/v1/tasks/")
    assert response.status_code == 200
    data = response.json()
    assert data["items"] == []
    assert data["total"] == 0
```

运行：`pytest`

## 2. 前端测试（可选）

### 2.1 安装
```
npm install -D vitest @vitest/ui @vue/test-utils jsdom
```

### 2.2 命令
`package.json`：
```json
"scripts": {
  "test": "vitest run",
  "test:ui": "vitest --ui"
}
```

### 2.3 示例
```javascript
import { mount } from '@vue/test-utils'
import Tasks from '@/views/Tasks.vue'

test('renders tasks page', () => {
  const wrapper = mount(Tasks)
  expect(wrapper.text()).toContain('任务管理')
})
```

## 3. CI 工作流（GitHub Actions）

`.github/workflows/ci.yml` 示例：
```yaml
name: CI

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install deps
        run: |
          cd backend
          pip install -r requirements-dev.txt
      - name: Run tests
        run: |
          cd backend
          pytest

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install & build & test
        run: |
          cd frontend
          npm install
          npm run build
          npm run test
```

## 4. lint/format

后端：
```bash
black app tests
isort app tests
flake8 app
```

前端：
```bash
npm run lint  # 需预先配置 ESLint/Prettier
```

在 CI 中添加相应命令，确保提交前通过。

## 5. Artifacts & 报告

上传 pytest 报告：
```yaml
  backend:
    steps:
      ...
      - name: Run tests
        run: |
          cd backend
          pytest --junitxml=pytest-report.xml
      - name: Upload pytest report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: backend/pytest-report.xml
```

前端构建产物、日志同理，可通过 `upload-artifact` 保留。
