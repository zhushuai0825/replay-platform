# 2. 后端脚手架（FastAPI + SQLAlchemy + Alembic）

1. 创建 Python 虚拟环境
   - 进入 `replay-platform/backend`
   - 运行 `python3 -m venv venv && source venv/bin/activate`
2. 安装依赖
   - 创建 `backend/requirements.txt`，填入：
     ```
     fastapi==0.111.0
     uvicorn[standard]==0.30.1
     sqlalchemy==2.0.30
     alembic==1.13.1
     psycopg2-binary==2.9.9
     python-dotenv==1.0.1
     pydantic-settings==2.2.1
     celery==5.4.0
     redis==5.0.4
     ```
   - 在虚拟环境内执行 `pip install -r requirements.txt`
3. 创建基础目录
   ```
   backend/
     app/
       __init__.py
       main.py
       config/settings.py
       database.py
       models.py
       api/v1/__init__.py
       api/v1/tasks.py
       api/v1/traffic.py
       api/v1/environments.py
     alembic.ini (init 后生成)
   ```
4. 编写配置文件 `app/config/settings.py`
   1. 创建文件并填入以下内容（可根据需要调整默认值）：
      ```python
      from pydantic_settings import BaseSettings
      from typing import List


      class Settings(BaseSettings):
          APP_NAME: str = "replay-platform"
          APP_ENV: str = "development"
          APP_DEBUG: bool = True
          APP_VERSION: str = "1.0.0"

          API_V1_PREFIX: str = "/api/v1"

          DATABASE_URL: str = "postgresql://replay_user:replay_password@postgres:5432/replay_db"
          REDIS_URL: str = "redis://redis:6379/0"
          CELERY_BROKER_URL: str = "redis://redis:6379/0"
          CELERY_RESULT_BACKEND: str = "redis://redis:6379/1"

          CORS_ORIGINS: List[str] = ["http://localhost:3000", "http://localhost:5173"]
          CORS_ALLOW_CREDENTIALS: bool = True

          class Config:
              env_file = ".env"
              case_sensitive = True

      settings = Settings()
      ```
   2. 如需从 `.env` 读取值，只需在 `.env` 中写入同名变量即可覆盖默认值。

5. 数据库与会话 `app/database.py`
   1. 文件内容示例：
      ```python
      from sqlalchemy import create_engine
      from sqlalchemy.orm import sessionmaker, declarative_base
      from app.config.settings import settings


      engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)
      SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
      Base = declarative_base()


      def get_db():
          db = SessionLocal()
          try:
              yield db
          finally:
              db.close()
      ```
   2. `pool_pre_ping=True` 可避免取到失效连接；`get_db()` 通过 `yield` 保证请求结束后自动关闭会话。

6. FastAPI 入口 `app/main.py`
   1. 文件内容参考：
      ```python
      from fastapi import FastAPI
      from fastapi.middleware.cors import CORSMiddleware
      from app.config.settings import settings
      from app.database import Base, engine

      # 在开发环境自动建表（生产建议使用 Alembic）
      if settings.APP_DEBUG:
          Base.metadata.create_all(bind=engine)

      app = FastAPI(
          title=settings.APP_NAME,
          version=settings.APP_VERSION,
          description="Replay Platform API"
      )

      app.add_middleware(
          CORSMiddleware,
          allow_origins=settings.CORS_ORIGINS,
          allow_credentials=settings.CORS_ALLOW_CREDENTIALS,
          allow_methods=["*"],
          allow_headers=["*"],
      )

      @app.get("/")
      async def root():
          return {"name": settings.APP_NAME, "version": settings.APP_VERSION}

      @app.get("/health")
      async def health():
          return {"status": "healthy"}

      from app.api.v1 import tasks, traffic, environments
      app.include_router(tasks.router, prefix=f"{settings.API_V1_PREFIX}/tasks", tags=["tasks"])
      app.include_router(traffic.router, prefix=f"{settings.API_V1_PREFIX}/traffic", tags=["traffic"])
      app.include_router(environments.router, prefix=f"{settings.API_V1_PREFIX}/environments", tags=["environments"])
      ```
   2. 根据需要在 `api/v1` 中创建各路由文件，并在此处统一挂载。
7. Alembic 初始化
   - 在 `backend` 目录执行 `alembic init migrations`
   - 修改 `alembic.ini` 中的 sqlalchemy.url，或在 `env.py` 通过 `settings.DATABASE_URL` 读取
8. 创建 `.env.example`
   ```
   APP_NAME=replay-platform
   APP_ENV=development
   APP_DEBUG=true
   DATABASE_URL=postgresql://replay_user:replay_password@postgres:5432/replay_db
   REDIS_URL=redis://redis:6379/0
   ```
9. 验证本地运行
   - `uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
   - 浏览器访问 `http://localhost:8000/docs`
