# 2. 后端脚手架（FastAPI + SQLAlchemy + Alembic）

1. 创建 Python 虚拟环境
   - 进入 `replay-platform/backend`
   - 运行 `python3 -m venv venv && source venv/bin/activate`
2. 安装依赖
   - 创建 `backend/requirements.txt`，填入：
     ```
     fastapi==0.111.0
     uvicorn[standard]==0.30.1
     sqlalchemy==2.0.30
     alembic==1.13.1
     psycopg2-binary==2.9.9
     python-dotenv==1.0.1
     pydantic-settings==2.2.1
     celery==5.4.0
     redis==5.0.4
     ```
   - 在虚拟环境内执行 `pip install -r requirements.txt`
3. 创建基础目录
   ```
   backend/
     app/
       __init__.py
       main.py
       config/settings.py
       database.py
       models.py
       api/v1/__init__.py
       api/v1/tasks.py
       api/v1/traffic.py
       api/v1/environments.py
     alembic.ini (init 后生成)
   ```
4. 编写配置文件 `app/config/settings.py`
   - 使用 `pydantic-settings` 定义 `Settings` 类，包含数据库URL、CORS、Celery配置等
   - 在文件末尾实例化 `settings = Settings()`
5. 数据库与会话 `app/database.py`
   - 使用 `create_engine(settings.DATABASE_URL, pool_pre_ping=True)`
   - 定义 `SessionLocal = sessionmaker(...)`、`Base = declarative_base()`
   - 提供 `get_db()` 依赖：`yield db` + `finally db.close()`
6. FastAPI 入口 `app/main.py`
   - 创建 `FastAPI(...)` 实例
   - 配置 CORS（allow_origins 从 settings 获取）
   - 注册路由：`from app.api.v1 import tasks, traffic, environments`
   - 提供 `/` 与 `/health` 路由
7. Alembic 初始化
   - 在 `backend` 目录执行 `alembic init migrations`
   - 修改 `alembic.ini` 中的 sqlalchemy.url，或在 `env.py` 通过 `settings.DATABASE_URL` 读取
8. 创建 `.env.example`
   ```
   APP_NAME=replay-platform
   APP_ENV=development
   APP_DEBUG=true
   DATABASE_URL=postgresql://replay_user:replay_password@postgres:5432/replay_db
   REDIS_URL=redis://redis:6379/0
   ```
9. 验证本地运行
   - `uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
   - 浏览器访问 `http://localhost:8000/docs`
