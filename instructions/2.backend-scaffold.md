# 2. 后端脚手架（FastAPI + SQLAlchemy + Alembic）

1. 创建 Python 虚拟环境
   - 进入 `replay-platform/backend`
   - 运行 `python3 -m venv venv && source venv/bin/activate`
2. 安装依赖
   - 创建 `backend/requirements.txt`，填入：
     ```
     fastapi==0.111.0
     uvicorn[standard]==0.30.1
     sqlalchemy==2.0.30
     alembic==1.13.1
     psycopg2-binary==2.9.9
     python-dotenv==1.0.1
     pydantic-settings==2.2.1
     celery==5.4.0
     redis==5.0.4
     ```
   - 在虚拟环境内执行 `pip install -r requirements.txt`
3. 创建基础目录
   ```
   backend/
     app/
       __init__.py
       main.py
       config/
         __init__.py
         settings.py
       databases.py
       models.py
       schemas/
         __init__.py
         task.py
       api/
         __init__.py
         tasks.py
         traffic.py
         environments.py
     alembic.ini (init 后生成)
   ```
4. 编写配置文件 `app/config/settings.py`
   1. 创建文件并填入以下内容（可直接复制当前版本的代码骨架）：
      ```python
      from pydantic_settings import BaseSettings
      from typing import List


      class Settings(BaseSettings):
          APP_NAME: str = "replay-platform"
          APP_ENV: str = "development"
          APP_DEBUG: bool = True
          APP_VERSION: str = "1.0.0"

          API_V1_PREFIX: str = "/api/v1"

          # 开发环境默认连接 localhost；FastAPI 运行在 Docker 中时可改为 postgres
          DATABASE_URL: str = "postgresql://replay_user:replay_password@localhost:5432/replay_db"

          REDIS_URL: str = "redis://localhost:6379/0"
          CELERY_BROKER_URL: str = "redis://localhost:6379/0"
          CELERY_RESULT_BACKEND: str = "redis://localhost:6379/1"

          CORS_ALLOW_ORIGINS: List[str] = ["http://localhost:3000", "http://localhost:5173", "http://localhost:5174"]
          CORS_ALLOW_CREDENTIALS: bool = True

          class Config:
              env_file = ".env"
              case_sensitive = True

      settings = Settings()
      ```
   2. `.env` 中写入同名变量即可覆盖默认值；例如 Docker Compose 内部运行时可设置 `DATABASE_URL=postgresql://...@postgres:5432/...`

5. 数据库与会话 `app/databases.py`
   1. 文件内容示例：
      ```python
      """
      Function : 数据库引擎和 Session 管理
      """

      from sqlalchemy import create_engine
      from sqlalchemy.orm import declarative_base, sessionmaker

      from .config.settings import settings

      engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)
      SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
      Base = declarative_base()


      def get_db():
          db = SessionLocal()
          try:
              yield db
          finally:
              db.close()
      ```
   2. 要点：
      - `pool_pre_ping=True` 可避免取到失效连接
      - FastAPI 中通过 `Depends(get_db)` 引入数据库会话
      - 一律使用相对导入 `from .config.settings`，避免出现 `ModuleNotFoundError`

++++++++++++++++++++++++++++++++++++++++++++++++++
6. FastAPI 入口 `app/main.py`
   1. 文件内容参考：
      ```python
      """
      Function : FastAPI 入口
      """

      import logging

      from fastapi import FastAPI
      from fastapi.middleware.cors import CORSMiddleware

      from .config.settings import settings
      from .databases import Base, engine

      logging.basicConfig(
          level=logging.INFO,
          format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
      )
      logger = logging.getLogger(__name__)

      if settings.APP_DEBUG:
          try:
              Base.metadata.create_all(bind=engine)
              logger.info("Database tables created successfully")
          except Exception as exc:
              logger.warning(
                  "Failed to create database tables: %s. The application will continue to run.",
                  exc,
              )

      app = FastAPI(
          title=settings.APP_NAME,
          version=settings.APP_VERSION,
          description="Replay Platform API",
      )

      app.add_middleware(
          CORSMiddleware,
          allow_origins=settings.CORS_ALLOW_ORIGINS,
          allow_credentials=settings.CORS_ALLOW_CREDENTIALS,
          allow_methods=["*"],
          allow_headers=["*"],
      )


      @app.get("/", summary="欢迎页", tags=["system"])
      async def root():
          return {"name": settings.APP_NAME, "version": settings.APP_VERSION}


      @app.get("/health", summary="健康检查", tags=["system"])
      async def health():
          return {"status": "healthy"}


      from .api import environments, tasks, traffic

      app.include_router(
          tasks.router,
          prefix=f"{settings.API_V1_PREFIX}/tasks",
          tags=["tasks"],
      )
      app.include_router(
          traffic.router,
          prefix=f"{settings.API_V1_PREFIX}/traffic",
          tags=["traffic"],
      )
      app.include_router(
          environments.router,
          prefix=f"{settings.API_V1_PREFIX}/environments",
          tags=["environments"],
      )
      ```
   2. 要点：
      - `api/` 目录下直接放任务/流量/环境路由，不再使用 `v1` 子目录
      - 统一使用相对导入
      - 调试模式自动建表，生产环境依旧通过 Alembic 控制
+++++++++++++++++++++++++++++++++++++++++++++++++++
7. Alembic 初始化
   - 在 `backend` 目录执行 `alembic init migrations`
   - 修改 `alembic.ini` 中的 sqlalchemy.url，或在 `env.py` 通过 `settings.DATABASE_URL` 读取
8. 创建 `.env.example`
   ```
   APP_NAME=replay-platform
   APP_ENV=development
   APP_DEBUG=true
   DATABASE_URL=postgresql://replay_user:replay_password@localhost:5432/replay_db
   REDIS_URL=redis://localhost:6379/0
   CELERY_BROKER_URL=redis://localhost:6379/0
   CELERY_RESULT_BACKEND=redis://localhost:6379/1
   ```
   - 如果 FastAPI 和 Postgres 都运行在 docker-compose 内部，可把 `localhost` 改成 `postgres`
9. 验证本地运行
   - `uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
   - 浏览器访问 `http://localhost:8000/docs`
