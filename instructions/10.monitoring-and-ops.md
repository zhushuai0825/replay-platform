# 10. 监控与运维（已实现功能）

> 当前代码已经完成日志封装与 Prometheus 指标输出，下面说明实现细节及扩展建议。

---

## 1. 日志体系（loguru）

- 位置：`app/utils/logger.py`
- 作用：
  - 使用 loguru 将日志输出到 stdout 与 `backend/logs/app.log`
  - 以 JSON 形式落盘，方便 Promtail / Filebeat 收集
- 使用方式：
  ```python
  from app.utils.logger import logger
  logger.info("message")
  logger.exception("error")
  ```
- `logs/` 目录已在仓库中（含 `.gitkeep`），运行时会自动创建 `app.log`

---

## 2. Prometheus 指标

- `app/main.py` 中通过 `Instrumentator().instrument(app).expose(app)` 暴露 `/metrics`
- 启动后访问 `http://localhost:8000/metrics` 可查看请求量、延迟等指标
- 如需对接 Grafana，只需在 Prometheus 配置中抓取该端点

---

## 3. 健康检查与日志配合

- `/health` 路由返回 `{"status": "healthy"}`，可供负载均衡与监控探针使用
- 关键操作（任务创建、文件上传、Celery 任务）均记录日志，便于排障

---

## 4. 运维日常检查

| 项目           | 操作/命令                                    |
|----------------|----------------------------------------------|
| 服务状态       | `docker compose ps` / `docker compose logs backend` |
| Celery 队列    | `redis-cli LLEN celery` 或使用 Flower        |
| 数据库         | `psql` / `docker compose logs postgres`      |
| 流量文件占用   | `du -sh backend/data/traffic`                |
| 指标/告警      | Prometheus 抓取 `/metrics`，Grafana 展示     |

---

## 5. 后续可扩展

1. **独立日志 API**：接入前端错误上报
2. **Trace ID**：在中间件中注入 `trace_id`，写入日志与响应头
3. **Celery 监控**：启用 Flower 或编写 exporter 输出任务成功率
4. **自动化脚本**：在 `scripts/` 目录添加磁盘/备份巡检工具

