# 7. 核心 API 实现（详细指南 + 示例代码）

## 1. 模型准备（`app/models.py`）

确保以下模型及字段存在（仅列关键字段）：

```python
class Environment(Base):
    __tablename__ = "environments"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), unique=True, nullable=False, index=True)
    base_url = Column(String(500), nullable=False)
    headers = Column(JSON, default={})
    auth_config = Column(JSON, default={})

class TrafficFile(Base):
    __tablename__ = "traffic_files"
    id = Column(Integer, primary_key=True, index=True)
    filename = Column(String(255), index=True)
    original_filename = Column(String(255))
    file_path = Column(String(500))
    file_size = Column(Integer)
    file_type = Column(String(50))
    created_at = Column(DateTime(timezone=True), server_default=func.now())

class ReplayTask(Base):
    __tablename__ = "replay_tasks"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False, index=True)
    traffic_file_id = Column(Integer, ForeignKey("traffic_files.id"), nullable=False)
    environment_id = Column(Integer, ForeignKey("environments.id"), nullable=False)
    status = Column(String(50), default="pending", index=True)
    progress = Column(Integer, default=0)
    total_requests = Column(Integer, default=0)
    completed_requests = Column(Integer, default=0)
    failed_requests = Column(Integer, default=0)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    started_at = Column(DateTime(timezone=True))
    completed_at = Column(DateTime(timezone=True))

class ReplayResult(Base):
    __tablename__ = "replay_results"
    id = Column(Integer, primary_key=True, index=True)
    task_id = Column(Integer, ForeignKey("replay_tasks.id"), nullable=False, index=True)
    request_index = Column(Integer)
    status = Column(String(50))
    diff_details = Column(JSON)
    response_time = Column(Integer)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

## 2. Schemas（Pydantic 模型）

示例 `app/schemas/task.py`：
```python
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime


class TaskCreate(BaseModel):
    name: str
    traffic_file_id: int
    environment_id: int


class TaskOut(BaseModel):
    id: int
    name: str
    status: str
    progress: int
    total_requests: int
    completed_requests: int
    failed_requests: int
    created_at: datetime

    class Config:
        orm_mode = True


class TaskListResponse(BaseModel):
    items: List[TaskOut]
    total: int
    page: int
    page_size: int
```

## 3. 任务 API（`app/api/v1/tasks.py`）

### 3.1 列表
```python
@router.get("/", response_model=TaskListResponse)
async def list_tasks(
    page: int = Query(1, ge=1),
    page_size: int = Query(10, ge=1, le=100),
    status: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
    db: Session = Depends(get_db),
):
    query = db.query(ReplayTask)
    if status:
        query = query.filter(ReplayTask.status == status)
    if search:
        query = query.filter(ReplayTask.name.ilike(f"%{search}%"))
    total = query.count()
    items = (
        query.order_by(ReplayTask.created_at.desc())
             .offset((page - 1) * page_size)
             .limit(page_size)
             .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}
```

### 3.2 创建任务
```python
@router.post("/", response_model=TaskOut)
async def create_task(task_in: TaskCreate, db: Session = Depends(get_db)):
    task = ReplayTask(**task_in.dict(), status="pending", progress=0)
    db.add(task)
    db.commit()
    db.refresh(task)
    celery_app.send_task("app.services.replay_engine.run_replay_task", args=[task.id])
    return task
```

### 3.3 详情与结果
```python
@router.get("/{task_id}", response_model=TaskOut)
async def get_task(task_id: int, db: Session = Depends(get_db)):
    task = db.query(ReplayTask).filter(ReplayTask.id == task_id).first()
    if not task:
        raise HTTPException(status_code=404, detail="Task not found")
    return task

@router.get("/{task_id}/results", response_model=ResultListResponse)
async def list_results(task_id: int, page: int = 1, page_size: int = 10,
                       status: Optional[str] = None, db: Session = Depends(get_db)):
    query = db.query(ReplayResult).filter(ReplayResult.task_id == task_id)
    if status:
        query = query.filter(ReplayResult.status == status)
    total = query.count()
    items = (
        query.order_by(ReplayResult.id.asc())
             .offset((page - 1) * page_size)
             .limit(page_size)
             .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}
```

## 4. 流量 API（`app/api/v1/traffic.py`）

### 上传
```python
@router.post("/upload", response_model=TrafficFileOut)
async def upload(file: UploadFile = File(...), db: Session = Depends(get_db)):
    unique_name = f"{uuid.uuid4().hex}_{file.filename}"
    save_path = Path(settings.TRAFFIC_FILE_STORAGE_PATH) / unique_name
    size_acc = 0
    with save_path.open("wb") as out:
        while chunk := await file.read(1024 * 1024):
            size_acc += len(chunk)
            if size_acc > settings.TRAFFIC_FILE_MAX_SIZE:
                save_path.unlink(missing_ok=True)
                raise HTTPException(status_code=400, detail="File too large")
            out.write(chunk)
    record = TrafficFile(
        filename=unique_name,
        original_filename=file.filename,
        file_path=str(save_path),
        file_size=size_acc,
        file_type=Path(file.filename).suffix.lstrip("."),
    )
    db.add(record); db.commit(); db.refresh(record)
    return record
```

### 列表
```python
@router.get("/", response_model=TrafficFileListResponse)
async def list_files(page: int = 1, page_size: int = 10, search: Optional[str] = None, db: Session = Depends(get_db)):
    query = db.query(TrafficFile)
    if search:
        query = query.filter(TrafficFile.original_filename.ilike(f"%{search}%"))
    total = query.count()
    items = (
        query.order_by(TrafficFile.created_at.desc())
             .offset((page - 1) * page_size)
             .limit(page_size)
             .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}
```

## 5. 环境 API（`app/api/v1/environments.py`）

```python
@router.post("/", response_model=EnvironmentOut)
async def create_environment(env_in: EnvironmentCreate, db: Session = Depends(get_db)):
    env = Environment(**env_in.dict())
    db.add(env); db.commit(); db.refresh(env)
    return env

@router.get("/", response_model=EnvironmentListResponse)
async def list_environments(page: int = 1, page_size: int = 10, db: Session = Depends(get_db)):
    query = db.query(Environment)
    total = query.count()
    items = (
        query.order_by(Environment.created_at.desc())
             .offset((page - 1) * page_size)
             .limit(page_size)
             .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}
```

## 6. 系统 API（可选）

在 `app/api/v1/system.py` 中提供 `/health`、`/metrics`、`/version` 等辅助接口。例如：
```python
@router.get("/info")
async def info():
    return {"app": settings.APP_NAME, "version": settings.APP_VERSION}
```

## 7. 测试用例示例

```python
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_task_list_empty():
    response = client.get("/api/v1/tasks/")
    assert response.status_code == 200
    data = response.json()
    assert data["items"] == []
    assert data["total"] == 0
```

- 可使用 pytest fixture 提供测试数据库，或使用 SQLite 内存库。