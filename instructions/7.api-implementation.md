# 7. 核心 API 实现（详细指南 + 示例代码）

## 1. 模型准备（`app/models.py`）

核心模型定义在 `app/models.py`，主要包括：

```python
"""
Function: 定义 ORM 数据模型
"""

from sqlalchemy import Column, DateTime, Integer, String, Boolean, Text, ForeignKey, JSON
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from .databases import Base


class TimestampMixin:
    """通用时间戳 mixin，所有表都可继承"""

    created_at = Column(DateTime(timezone=True), server_default=func.now(), comment="创建时间")
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), comment="更新时间")


class User(Base, TimestampMixin):
    """用户表，记录登录账户信息"""

    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True, comment="自增 ID")
    username = Column(String(50), unique=True, nullable=False, index=True, comment="用户名")
    email = Column(String(100), unique=True, nullable=False, index=True, comment="邮箱")
    hashed_password = Column(String(255), nullable=False, comment="BCrypt 加密后的密码")
    role = Column(String(50), default="user", nullable=False, comment="角色")
    is_active = Column(Boolean, default=True, comment="是否启用")

    traffic_files = relationship("TrafficFile", back_populates="creator", cascade="all, delete-orphan")
    replay_tasks = relationship("ReplayTask", back_populates="creator", cascade="all, delete-orphan")


class Environment(Base, TimestampMixin):
    """目标环境配置"""

    __tablename__ = "environments"
    id = Column(Integer, primary_key=True, index=True, comment="环境 ID")
    name = Column(String(100), unique=True, nullable=False, index=True, comment="环境名称")
    base_url = Column(String(500), nullable=False, comment="基础 URL")
    description = Column(String(255), nullable=True, comment="环境描述")
    headers = Column(JSON, default=dict, comment="默认请求头")
    auth_config = Column(JSON, default=dict, comment="鉴权配置")

    replay_tasks = relationship("ReplayTask", back_populates="environment")


class TrafficFile(Base, TimestampMixin):
    """流量文件（HAR / JSON）"""

    __tablename__ = "traffic_files"
    id = Column(Integer, primary_key=True, index=True, comment="文件 ID")
    filename = Column(String(255), index=True, comment="存储文件名")
    original_filename = Column(String(255), comment="上传时的原始文件名")
    file_path = Column(String(500), comment="磁盘路径")
    file_size = Column(Integer, comment="大小（字节）")
    file_type = Column(String(50), comment="类型（json/har）")
    description = Column(Text, nullable=True, comment="备注")
    created_by = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, comment="上传者 ID")

    creator = relationship("User", back_populates="traffic_files")
    replay_tasks = relationship("ReplayTask", back_populates="traffic_file")


class ReplayTask(Base, TimestampMixin):
    """回放任务"""

    __tablename__ = "replay_tasks"
    id = Column(Integer, primary_key=True, index=True, comment="任务 ID")
    name = Column(String(200), nullable=False, index=True, comment="任务名称")
    traffic_file_id = Column(Integer, ForeignKey("traffic_files.id", ondelete="CASCADE"), nullable=False, comment="流量文件 ID")
    environment_id = Column(Integer, ForeignKey("environments.id", ondelete="RESTRICT"), nullable=False, comment="运行环境 ID")
    created_by = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, comment="创建者 ID")
    status = Column(String(50), default="pending", index=True, comment="状态（pending/running/...）")
    progress = Column(Integer, default=0, comment="进度百分比")
    total_requests = Column(Integer, default=0, comment="总请求数")
    completed_requests = Column(Integer, default=0, comment="成功数")
    failed_requests = Column(Integer, default=0, comment="失败数")
    started_at = Column(DateTime(timezone=True), comment="开始时间")
    completed_at = Column(DateTime(timezone=True), comment="完成时间")
    summary = Column(Text, nullable=True, comment="任务总结")

    traffic_file = relationship("TrafficFile", back_populates="replay_tasks")
    environment = relationship("Environment", back_populates="replay_tasks")
    creator = relationship("User", back_populates="replay_tasks")
    results = relationship("ReplayResult", back_populates="task", cascade="all, delete-orphan")


class ReplayResult(Base, TimestampMixin):
    """单条请求的比对结果"""

    __tablename__ = "replay_results"
    id = Column(Integer, primary_key=True, index=True, comment="结果 ID")
    task_id = Column(Integer, ForeignKey("replay_tasks.id", ondelete="CASCADE"), nullable=False, index=True, comment="所属任务")
    request_index = Column(Integer, comment="请求顺序")
    original_request = Column(JSON, comment="原始请求")
    original_response = Column(JSON, comment="原始响应")
    replayed_request = Column(JSON, comment="回放请求")
    replayed_response = Column(JSON, comment="回放响应")
    status = Column(String(50), comment="结果状态（success/diff/failed）")
    diff_details = Column(JSON, comment="差异详情 JSON")
    response_time = Column(Integer, comment="耗时（毫秒）")

    task = relationship("ReplayTask", back_populates="results")
```

## 2. Schemas（Pydantic 模型）

示例 `app/schemas/task.py`（带注释）：
```python
"""
Function : 定义任务相关的 Pydantic Schema
"""

from datetime import datetime
from typing import List

from pydantic import BaseModel


class TaskCreate(BaseModel):
    """创建任务所需的字段"""

    name: str              # 任务名称
    traffic_file_id: int   # 关联的流量文件 ID
    environment_id: int    # 运行环境 ID


class TaskOut(BaseModel):
    """返回给前端的任务信息"""

    id: int
    name: str
    status: str
    progress: int
    total_requests: int
    completed_requests: int
    failed_requests: int
    created_at: datetime

    class Config:
        orm_mode = True  # 允许直接从 ORM 对象转换


class TaskListResponse(BaseModel):
    """任务列表响应结构"""

    items: List[TaskOut]
    total: int
    page: int
    page_size: int
```

## 3. 任务 API（`app/api/tasks.py`）

当前端点示例（带注释）：

```python
"""
Function : 任务相关接口
"""

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session

from ..databases import get_db
from ..models import ReplayTask
from ..schemas.task import TaskCreate, TaskListResponse, TaskOut

router = APIRouter(prefix="", tags=["tasks"])


@router.get("/", response_model=TaskListResponse, summary="任务列表")
async def list_tasks(
    page: int = Query(1, ge=1, description="页码"),
    page_size: int = Query(10, ge=1, le=100, description="每页条数"),
    db: Session = Depends(get_db),
):
    """分页查询任务"""

    query = db.query(ReplayTask)
    total = query.count()
    items = (
        query.order_by(ReplayTask.created_at.desc())
        .offset((page - 1) * page_size)
        .limit(page_size)
        .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}


@router.post("/", response_model=TaskOut, summary="创建任务")
async def create_task(payload: TaskCreate, db: Session = Depends(get_db)):
    """创建新的回放任务"""

    task = ReplayTask(
        name=payload.name,
        traffic_file_id=payload.traffic_file_id,
        environment_id=payload.environment_id,
    )
    db.add(task)
    db.commit()
    db.refresh(task)
    return task
```

> 当前 `tasks.py` 只有列表和创建两个端点，后续可继续按需增加详情、结果列表、过滤等逻辑。

## 4. 流量 API（`app/api/v1/traffic.py`）

目前 `app/api/traffic.py` 仅提供占位示例（返回空列表），可在完成文件存储逻辑后再粘贴真实代码。

## 5. 环境 API（`app/api/v1/environments.py`）

目前 `app/api/environments.py` 同样是占位路由（返回空列表），后续可按需求扩展创建/查询等接口。

> 目前系统 API 和测试用例尚未编写，可在需要时参考 FastAPI 官方文档添加 `/health` 等路由，并用 `TestClient`/`pytest` 编写测试。