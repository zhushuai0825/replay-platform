# 18. 部署策略

# 18. 部署策略（逐步指南）

## 1. 开发环境（docker compose）
```bash
docker compose build
docker compose up -d
docker compose ps
```
- 通过 .env 管理变量
- 数据持久化：Postgres 使用命名卷 `postgres_data`

## 2. 测试环境
- 在测试服务器（云主机）上安装 Docker/Docker Compose
- 克隆仓库，配置 `.env`（使用测试数据库/Redis/域名）
- 启动 compose，并配置反向代理（Nginx）暴露 80/443
- 日志输出：将 `logs/` 目录挂载到宿主机，配合 logrotate

## 3. 生产环境示例（K8s）
- 组件映射：
  - 后端 → Deployment + Service
  - 前端 → Nginx Deployment + Service
  - Postgres / Redis → StatefulSet + PVC
  - Celery Worker → Deployment
- 使用 Helm Chart：
  ```
  helm install replay-platform charts/replay-platform \
    --set backend.image.tag=1.0.0 \
    --set frontend.image.tag=1.0.0
  ```
- 环境变量通过 ConfigMap/Secret 注入

## 4. CI/CD
- 构建镜像并推送：
  ```bash
  docker build -t registry.example.com/backend:$(git rev-parse --short HEAD) backend
  docker push registry.example.com/backend:...
  ```
- GitHub Actions + ArgoCD:
  - Actions 构建并推送镜像，更新 Helm values
  - ArgoCD 监听 GitOps 仓库，自动同步

## 5. 回滚策略
- 镜像版本：保留上一版本 tag，`kubectl set image` 回滚
- 数据库迁移：`alembic downgrade <revision>` 或备份恢复
- Compose 环境：`docker compose down`，切换到上一版本镜像再 `up`
