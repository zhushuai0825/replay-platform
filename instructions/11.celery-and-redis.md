# 11. Celery 与 Redis 配置（详细步骤）

1. **安装/启动 Redis**
   - 使用 docker compose：`docker compose up -d redis`
   - 或本地运行 `redis-server`，确保地址与 `.env` 中一致
2. **配置 `.env`**
   ```
   CELERY_BROKER_URL=redis://redis:6379/0
   CELERY_RESULT_BACKEND=redis://redis:6379/1
   ```
3. **`app/celery_app.py`**
   ```python
   from celery import Celery
   from app.config.settings import settings

   celery_app = Celery(
       "replay_platform",
       broker=settings.CELERY_BROKER_URL,
       backend=settings.CELERY_RESULT_BACKEND,
       include=["app.services.replay_engine"],
   )

   celery_app.conf.update(
       task_serializer="json",
       result_serializer="json",
       accept_content=["json"],
       timezone="Asia/Shanghai",
       enable_utc=True,
   )
   ```
4. **示例任务 `app/services/replay_engine.py`**
   ```python
   from app.celery_app import celery_app
   from app.database import SessionLocal
   from app.models import ReplayTask
   from datetime import datetime
   import time

   @celery_app.task(name="app.services.replay_engine.run_replay_task")
   def run_replay_task(task_id: int):
       db = SessionLocal()
       try:
           task = db.query(ReplayTask).get(task_id)
           if not task:
               return "task_not_found"
           task.status = "running"
           task.started_at = datetime.utcnow()
           task.total_requests = 5
           db.commit()
           for i in range(1, 6):
               time.sleep(1)
               task.completed_requests = i
               task.progress = int(i * 100 / 5)
               db.commit()
           task.status = "completed"
           task.completed_at = datetime.utcnow()
           db.commit()
           return "ok"
       except Exception:
           if task:
               task.status = "failed"
               db.commit()
           raise
       finally:
           db.close()
   ```
5. **触发任务**
   ```python
   celery_app.send_task("app.services.replay_engine.run_replay_task", args=[task.id])
   ```
6. **启动 Worker**
   ```bash
   cd backend
   celery -A app.celery_app.celery_app worker --loglevel=info
   ```
