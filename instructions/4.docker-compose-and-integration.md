# 4. Docker & 集成步骤

1. 在仓库根目录创建 `docker-compose.yml`
   ```yaml
   version: "3.9"
   services:
     postgres:
       image: postgres:15-alpine
       environment:
         POSTGRES_USER: replay_user
         POSTGRES_PASSWORD: replay_password
         POSTGRES_DB: replay_db
       volumes:
         - postgres_data:/var/lib/postgresql/data
       ports:
         - "5432:5432"
       healthcheck:
         test: ["CMD-SHELL", "pg_isready -U replay_user"]
         interval: 10s
         timeout: 5s
         retries: 5
     redis:
       image: redis:7-alpine
       ports:
         - "6379:6379"
       healthcheck:
         test: ["CMD", "redis-cli", "ping"]
         interval: 10s
         timeout: 5s
         retries: 5
     backend:
       build: ./backend
       env_file:
         - ./backend/.env
       depends_on:
         postgres:
           condition: service_healthy
         redis:
           condition: service_healthy
       ports:
         - "8000:8000"
     frontend:
       build: ./frontend
       ports:
         - "3000:80"
     celery-worker:
       build:
         context: ./backend
         dockerfile: celery.Dockerfile
       env_file:
         - ./backend/.env
       depends_on:
         redis:
           condition: service_healthy
   volumes:
     postgres_data:
   ```
2. 为 backend 创建 `Dockerfile`
   ```Dockerfile
   FROM python:3.11-slim
   WORKDIR /app
   COPY backend/requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   COPY backend/ .
   CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
   ```
3. 为 Celery worker 创建 `celery.Dockerfile`
   ```Dockerfile
   FROM python:3.11-slim
   WORKDIR /app
   COPY backend/requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   COPY backend/ .
   CMD ["celery", "-A", "app.celery_app.celery_app", "worker", "--loglevel=info"]
   ```
4. 前端 Dockerfile（生产）
   ```Dockerfile
   FROM node:18-alpine AS build
   WORKDIR /app
   COPY frontend/package*.json ./
   RUN npm install
   COPY frontend/ .
   RUN npm run build

   FROM nginx:alpine
   COPY --from=build /app/dist /usr/share/nginx/html
   ```
5. 启动与验证
   - `docker compose build`
   - `docker compose up -d`
   - 浏览器访问：`http://localhost:3000`（前端）、`http://localhost:8000/docs`
6. 常见问题
   - 镜像下载慢 → 配置 Docker Desktop `registry-mirrors`
   - 服务未就绪 → 使用 `docker compose logs -f [service]` 排查
   - 数据持久化 → 确认命名卷 `postgres_data` 已挂载
