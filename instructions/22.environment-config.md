# 22. 运行环境配置（多场景）

> 本文整理本地、测试、生产环境应具备的配置项与注意事项，方便在不同场景快速复现。

---

## 1. 本地开发

| 组件     | 配置                                                         |
|----------|--------------------------------------------------------------|
| Python   | 3.11（venv），`pip install -r backend/requirements.txt`      |
| Node     | 18+，`npm install`                                           |
| Docker   | Desktop >= 4.28（用于 Postgres/Redis/Celery）                |
| Redis    | `docker compose up -d redis`                                 |
| Postgres | `docker compose up -d postgres`                              |
| Celery   | `celery -A app.celery_app worker --loglevel=info`            |

`.env` 示例：
```
DATABASE_URL=postgresql://replay_user:replay_password@localhost:5432/replay_db
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/1
```

---

## 2. 测试环境（云主机）

- 安装 Docker + docker compose
- 使用 `.env.testing` 与生产同结构、不同凭据
- 通过 `docker compose -f docker-compose.yml up -d` 一键启动后端、前端、数据库、Redis
- 配置 Nginx 反向代理：
  ```
  server {
    listen 80;
    location /api/ { proxy_pass http://backend:8000/; }
    location / { proxy_pass http://frontend:3000/; }
  }
  ```
- 挂载 `backend/logs`、`backend/data` 到宿主机，配合 logrotate

---

## 3. 生产环境（K8s 示例）

| 组件        | 建议资源                           | 说明                                 |
|-------------|------------------------------------|--------------------------------------|
| 后端 API    | Deployment，2~3 副本               | 通过 ConfigMap/Secret 注入配置      |
| Celery      | Deployment，水平扩容               | 监听 Redis 队列                      |
| Redis/PG    | StatefulSet + PVC                  | 建议托管服务或高可用部署            |
| 前端静态页  | Nginx Deployment 或对象存储 + CDN  | 通过 ConfigMap 注入 `index.html`    |
| Prometheus  | 监控 `/metrics`                    | 可使用 kube-prometheus-stack         |

---

## 4. 配置项管理

- 将公共配置写在 `.env.example`，按环境复制为 `.env.development`、`.env.testing`、`.env.production`
- 使用 Python 的 `settings.py` 统一读取：
  - `DATABASE_URL`
  - `REDIS_URL`
  - `CELERY_BROKER_URL`、`CELERY_RESULT_BACKEND`
  - `TRAFFIC_FILE_STORAGE_PATH`
- 敏感信息（数据库密码、JWT 密钥）存入 Vault / SSM / Secret Manager

---

## 5. 环境验证清单

1. `docker compose ps` / `kubectl get pods` → 所有服务 Running
2. 后端：`curl http://<host>:8000/health`
3. 前端：打开浏览器访问页面，检查 API 是否可用
4. Redis：`redis-cli ping`
5. Celery Worker：日志输出 `ready`

---

## 6. 待补充

- 自动化配置脚本（Ansible/Terraform）
- HTTPS 证书自动续期（Let's Encrypt 或 Cloudflare）
- 多集群/多区域部署策略

