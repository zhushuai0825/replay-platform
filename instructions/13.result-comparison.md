# 13. 结果比对与任务详情（实现指南）

## 1. 数据模型补充

在 `ReplayResult` 中保留原始与回放的请求/响应，便于 diff：
```python
class ReplayResult(Base):
    __tablename__ = "replay_results"
    id = Column(Integer, primary_key=True, index=True)
    task_id = Column(Integer, ForeignKey("replay_tasks.id"), index=True, nullable=False)
    request_index = Column(Integer)
    original_request = Column(JSON)
    original_response = Column(JSON)
    replayed_request = Column(JSON)
    replayed_response = Column(JSON)
    status = Column(String(50))  # success/failed/diff
    diff_details = Column(JSON)
    response_time = Column(Integer)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

## 2. 比对流程示例

伪代码（可放在 `app/services/result_comparator.py`）：
```python
def compare_responses(original: dict, replayed: dict, ignore_paths: List[str]) -> dict:
    # 1. 根据 ignore_paths 删除对应字段
    # 2. 使用深度对比（手写或利用 deepdiff/jsondiff）
    # 3. 返回差异详情
    ...
```

## 3. API 详情

### 3.1 任务详情 `GET /api/v1/tasks/{id}`
返回字段示例：
```json
{
  "id": 1,
  "name": "demo",
  "status": "running",
  "progress": 60,
  "total_requests": 100,
  "completed_requests": 60,
  "failed_requests": 2,
  "environment": { "id": 1, "name": "test", "base_url": "http://..." },
  "traffic_file": { "id": 5, "original_filename": "test.har", "file_size": 1024 },
  "created_at": "2025-11-16T01:00:00Z",
  "started_at": "2025-11-16T01:00:10Z",
  "completed_at": null
}
```

### 3.2 结果列表 `GET /api/v1/tasks/{id}/results`
支持参数：`page/page_size/status`，返回 `items/total/page/page_size`

## 4. 前端展示建议

- 任务详情页：信息卡（环境、流量文件、创建时间）、进度条、统计卡片（总量/成功/失败）
- 结果列表：状态筛选 + 表格；提供“查看详情”按钮展示 diff
- diff 展示：左右对比（JSON 高亮）或列表展示差异路径

## 5. 扩展方向

- diff 规则配置：JSONPath/正则忽略字段
- 结果导出：将 `diff_details` 生成报告（HTML/PDF）
- 任务报告：汇总任务总体情况、失败请求、差异统计
