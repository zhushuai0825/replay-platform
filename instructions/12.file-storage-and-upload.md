# 12. 流量文件存储与上传策略（详细指南）

## 1. 目录结构
```
backend/data/
  traffic/   # 实际存储流量文件
  temp/      # 临时文件、解压目录
```
在 Git 中保留 `.gitkeep`，避免空目录被忽略。

## 2. 配置（已写入 `app/config/settings.py`）
```python
BASE_DIR: Path = Path(__file__).resolve().parents[2]
DATA_DIR: Path = BASE_DIR / "data"
TRAFFIC_FILE_STORAGE_PATH: str = str(DATA_DIR / "traffic")
TRAFFIC_FILE_TEMP_PATH: str = str(DATA_DIR / "temp")
TRAFFIC_FILE_MAX_SIZE: int = 50 * 1024 * 1024
```

## 3. 接口实现 `app/api/traffic.py`
```python
@router.post("/upload", response_model=TrafficFileOut)
async def upload_traffic_file(file: UploadFile = File(...), db: Session = Depends(get_db)):
    unique_name = f"{uuid.uuid4().hex}_{file.filename}"
    save_path = STORAGE_PATH / unique_name
    total_size = 0
    try:
        with save_path.open("wb") as buffer:
            while chunk := await file.read(1024 * 1024):
                total_size += len(chunk)
                if total_size > settings.TRAFFIC_FILE_MAX_SIZE:
                    raise HTTPException(status_code=400, detail="文件过大")
                buffer.write(chunk)
    except HTTPException:
        save_path.unlink(missing_ok=True)
        raise
    except Exception as exc:
        save_path.unlink(missing_ok=True)
        logger.exception("写入流量文件失败")
        raise HTTPException(status_code=500, detail="保存文件失败") from exc

    record = TrafficFile(
        filename=unique_name,
        original_filename=file.filename,
        file_path=str(save_path),
        file_size=total_size,
        file_type=Path(file.filename).suffix.lstrip("."),
    )
    db.add(record); db.commit(); db.refresh(record)
    return record


@router.get("/", response_model=TrafficFileListResponse)
async def list_traffic(page: int = 1, page_size: int = 10, search: str | None = None, db: Session = Depends(get_db)):
    query = db.query(TrafficFile)
    if search:
        query = query.filter(TrafficFile.original_filename.ilike(f"%{search}%"))
    total = query.count()
    items = (
        query.order_by(TrafficFile.created_at.desc())
        .offset((page - 1) * page_size)
        .limit(page_size)
        .all()
    )
    return {"items": items, "total": total, "page": page, "page_size": page_size}
```

## 4. Pydantic Schema
`app/schemas/traffic.py`：
```python
class TrafficFileOut(BaseModel):
    id: int
    original_filename: str
    file_size: int
    file_type: str | None = None
    created_at: datetime

    class Config:
        orm_mode = True


class TrafficFileListResponse(BaseModel):
    items: List[TrafficFileOut]
    total: int
    page: int
    page_size: int
```

## 5. 元数据字段
- `filename`: 唯一文件名（含 UUID）
- `original_filename`: 上传时的原始文件名
- `file_path`: 本地存储路径
- `file_size`: 字节数
- `file_type`: 后缀（json/txt/log/har 等）
- `created_at`: 数据库存储时间

## 6. 前端上传
```javascript
const form = new FormData()
form.append('file', selectedFile)
await api.post('/api/v1/traffic/upload', form, {
  headers: { 'Content-Type': 'multipart/form-data' },
})
```
- 上传成功后刷新列表：`GET /api/v1/traffic/?page=1&page_size=10`
- 可显示上传进度（axios `onUploadProgress`）

## 7. 扩展策略
- 大文件：上传到 MinIO/S3，数据库记录 presigned URL
- 清理脚本：`scripts/cleanup_old_files.py`，按时间/空间限制自动清理
- 权限控制：仅允许特定角色上传/下载
