# 12. 流量文件存储与上传策略（详细指南）

## 1. 目录结构
```
backend/data/
  traffic/   # 实际存储流量文件
  temp/      # 临时文件、解压目录
```
在 Git 中保留 `.gitkeep`，避免空目录被忽略。

## 2. 配置
`settings.py` 中添加：
```python
TRAFFIC_FILE_STORAGE_PATH: str = "./data/traffic"
TRAFFIC_FILE_MAX_SIZE: int = 104857600  # 100MB
```

## 3. 上传接口 `app/api/v1/traffic.py`
```python
@router.post("/upload", response_model=TrafficFileOut)
async def upload(file: UploadFile = File(...), db: Session = Depends(get_db)):
    storage_dir = Path(settings.TRAFFIC_FILE_STORAGE_PATH)
    storage_dir.mkdir(parents=True, exist_ok=True)

    unique_name = f"{uuid.uuid4().hex}_{file.filename}"
    save_path = storage_dir / unique_name
    size_acc = 0

    with save_path.open("wb") as out:
        while chunk := await file.read(1024 * 1024):  # 1MB
            size_acc += len(chunk)
            if size_acc > settings.TRAFFIC_FILE_MAX_SIZE:
                save_path.unlink(missing_ok=True)
                raise HTTPException(status_code=400, detail="File too large")
            out.write(chunk)

    record = TrafficFile(
        filename=unique_name,
        original_filename=file.filename,
        file_path=str(save_path),
        file_size=size_acc,
        file_type=Path(file.filename).suffix.lstrip("."),
    )
    db.add(record); db.commit(); db.refresh(record)
    return record
```

## 4. 元数据字段
- `filename`: 唯一文件名（含 UUID）
- `original_filename`: 上传时的原始文件名
- `file_path`: 本地存储路径
- `file_size`: 字节数
- `file_type`: 后缀（json/txt/log/har 等）
- `created_at`: 数据库存储时间

## 5. 前端上传
```javascript
const form = new FormData()
form.append('file', selectedFile)
await api.post('/api/v1/traffic/upload', form, {
  headers: { 'Content-Type': 'multipart/form-data' },
})
```
- 上传成功后刷新列表：`GET /api/v1/traffic/?page=1&page_size=10`
- 可显示上传进度（axios `onUploadProgress`）

## 6. 扩展策略
- 大文件：上传到 MinIO/S3，数据库记录 presigned URL
- 清理脚本：`scripts/cleanup_old_files.py`，按时间/空间限制自动清理
- 权限控制：仅允许特定角色上传/下载
