# 6. 数据库初始化与迁移

1. 在 `backend/.env` 中填写数据库连接信息（参考 `.env.example`）：
   ```
   DATABASE_URL=postgresql://replay_user:replay_password@localhost:5432/replay_db
   ```
2. 启动本地 Postgres

   **推荐方式：使用 Docker Compose（无需单独安装 PostgreSQL）**
   
   ```bash
   # 在项目根目录运行，会自动下载 PostgreSQL 镜像并启动容器
   docker compose up -d postgres
   ```
   
   - PostgreSQL 会作为 Docker 容器运行，用户名/密码已在 `docker-compose.yml` 中配置
   - 数据会持久化在 Docker volume 中，容器重启不会丢失数据
   - 验证连接：`docker compose exec postgres psql -U replay_user -d replay_db`
   
   **注意：** 如果使用 Docker Compose，`DATABASE_URL` 中的主机名应该是 `postgres`（容器名），而不是 `localhost`：
   ```
   DATABASE_URL=postgresql://replay_user:replay_password@postgres:5432/replay_db
   ```
   
   **备选方式：使用本地安装的 PostgreSQL**
   - 如果本地已安装 PostgreSQL，确保用户/密码/数据库与 `.env` 中一致
   - 此时 `DATABASE_URL` 中的主机名使用 `localhost`
3. 初始化 Alembic（如果尚未执行）
   ```bash
   cd backend
   alembic init migrations
   ```
   修改 `alembic.ini` 中的 `sqlalchemy.url`（可留空，通过 env.py 动态加载）。
4. 配置 `migrations/env.py` 以使用 Settings
   ```python
   import sys
   from logging.config import fileConfig
   from sqlalchemy import engine_from_config, pool
   from alembic import context
   from app.config.settings import settings
   from app.database import Base

   config = context.config
   config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)

   if config.config_file_name is not None:
       fileConfig(config.config_file_name)

   target_metadata = Base.metadata

   def run_migrations_offline():
       url = config.get_main_option("sqlalchemy.url")
       context.configure(url=url, target_metadata=target_metadata, literal_binds=True)
       with context.begin_transaction():
           context.run_migrations()

   def run_migrations_online():
       connectable = engine_from_config(
           config.get_section(config.config_ini_section),
           prefix="sqlalchemy.",
           poolclass=pool.NullPool,
       )
       with connectable.connect() as connection:
           context.configure(connection=connection, target_metadata=target_metadata)
           with context.begin_transaction():
               context.run_migrations()

   if context.is_offline_mode():
       run_migrations_offline()
   else:
       run_migrations_online()
   ```
5. 生成首个迁移
   ```bash
   alembic revision --autogenerate -m "init"
   ```
   - 打开 `migrations/versions/<timestamp>_init.py`，确认自动生成的表结构正确。
6. 应用迁移到数据库
   ```bash
   alembic upgrade head
   ```
   - 如果需要回滚：`alembic downgrade -1`
7. 验证表结构
   - `psql`：`\dt` 查看所有表，`\d replay_tasks` 查看字段
   - GUI 工具：TablePlus、DBeaver、pgAdmin 等
8. 后续模型更新时：
   - 修改 `app/models.py`
   - `alembic revision --autogenerate -m "描述"` → 检查生成文件 → `alembic upgrade head`
