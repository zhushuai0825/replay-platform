# 14. 认证与安全加固（当前状态 + 待办）

> 目前项目仅定义了 `User` 模型，没有注册/登录/JWT 等功能。本章说明现状，并列出后续需要补齐的内容。

---

## 1. 现状

- `app/models.py` 中有 `User` 表，但没有任何接口使用它
- 没有密码哈希、JWT、用户会话、角色校验
- CORS 已配置（允许本地前端），但没有 HTTPS / CSRF / Rate Limit 等措施

---

## 2. 待实现事项

1. **密码与注册**  
   - 使用 `passlib`（BCrypt）哈希密码  
   - 提供注册/创建用户接口或初始化脚本
2. **登录与 JWT**  
   - 引入 OAuth2 Password Flow (`fastapi.security.OAuth2PasswordBearer`)  
   - 在 `settings.py` 中添加 `SECRET_KEY`、`ACCESS_TOKEN_EXPIRE_MINUTES`、`ALGORITHM`  
   - 编写 `create_access_token` 和 `get_current_user`
3. **接口保护**  
   - 在需要登录的接口上 `Depends(get_current_user)`  
   - 根据 `User.role` 判断是否允许访问
4. **安全基线**  
   - HTTP → HTTPS (Nginx/Ingress)  
   - 日志脱敏（避免输出 Token、密码）  
   - 流量文件脱敏脚本，过滤手机号/身份证等

---

## 3. 推荐实施顺序

1. 完成注册/登录/刷新 Token 接口
2. 将任务、流量、环境等 API 改为登录后访问
3. 添加管理员角色，用于创建环境、查看结果
4. 搭配前端：在 axios 拦截器中附带 `Authorization`，并处理 401 跳转

---

## 4. 额外建议

- **日志**：当打印请求体时记得脱敏；目前 loguru 已启用，可在记录时添加 `extra={"user_id": ...}`
- **Rate Limit**：可考虑在 Nginx 或 API 层加入节流（如 slowapi）
- **安全头部**：在 Nginx/Ingress 配置 `Content-Security-Policy`、`Strict-Transport-Security`

> 等到你真正实现了登录/鉴权，再回来更新本章节的“待办”部分，把它替换为具体代码和步骤。
