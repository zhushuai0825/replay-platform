# 14. 认证与安全加固（详细指南）

## 1. 账号体系
- `User` 模型示例：
  ```python
  class User(Base):
      __tablename__ = "users"
      id = Column(Integer, primary_key=True, index=True)
      username = Column(String(50), unique=True, index=True, nullable=False)
      email = Column(String(100), unique=True, index=True, nullable=False)
      hashed_password = Column(String(255), nullable=False)
      role = Column(String(50), default="user")
      is_active = Column(Boolean, default=True)
  ```
- 使用 `passlib`：
  ```python
  from passlib.context import CryptContext
  pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
  def verify_password(plain, hashed): return pwd_context.verify(plain, hashed)
  def get_password_hash(password): return pwd_context.hash(password)
  ```

## 2. JWT 认证
- 配置（`settings.py`）：
  ```
  SECRET_KEY=your-secret-key
  ACCESS_TOKEN_EXPIRE_MINUTES=60
  ALGORITHM=HS256
  ```
- Token 工具：
  ```python
  from jose import JWTError, jwt
  from datetime import datetime, timedelta

  def create_access_token(data: dict, expires_delta: timedelta):
      to_encode = data.copy()
      expire = datetime.utcnow() + expires_delta
      to_encode.update({"exp": expire})
      return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)

  def get_current_user(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):
      try:
          payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
          username = payload.get("sub")
      except JWTError:
          raise HTTPException(status_code=401, detail="Invalid token")
      user = db.query(User).filter(User.username == username).first()
      if not user:
          raise HTTPException(status_code=401, detail="User not found")
      return user
  ```
- 登录接口：校验密码成功后创建 token：
  ```python
  access_token = create_access_token({"sub": user.username}, timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES))
  return {"access_token": access_token, "token_type": "bearer"}
  ```

## 3. CORS 配置
- 在 `settings.CORS_ORIGINS` 中配置允许的前端域名
- 生产环境仅允许正式域名；开发环境可包含 localhost/127.0.0.1

## 4. HTTPS
- 开发可使用 http；生产务必通过 Nginx/ALB/Ingress 配置 TLS
- 将 `SECURE_COOKIES`、`HSTS` 等安全头部加到 Nginx/网关配置中

## 5. 数据脱敏与日志
- 日志中避免打印 Token/密码/敏感请求体
- 流量文件上传前可使用脚本脱敏（手机号、身份证等）
- 提供配置项控制脱敏字段列表（如 JSONPath）
