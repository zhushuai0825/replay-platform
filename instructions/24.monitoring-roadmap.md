# 24. 监控与告警路线图

> 第 10 章已经描述当前完成的部分（日志、Prometheus）。本章进一步规划完整的监控体系。

---

## 1. Prometheus & Grafana

- [ ] 在测试/生产环境部署 Prometheus  
- [ ] 添加 scrape config：
  ```yaml
  - job_name: replay-backend
    metrics_path: /metrics
    static_configs:
      - targets:
          - backend-service:8000
  ```
- [ ] 导入 FastAPI/Gunicorn/Celery/Redis Dashboard

---

## 2. 日志集中化

- [ ] 搭建 ELK / Loki Stack（或使用云服务，如 CloudWatch、Aliyun SLS）  
- [ ] 配置 Filebeat/Promtail 收集 `backend/logs/app.log`  
- [ ] 在 Grafana 中配置日志数据源，结合指标排障

---

## 3. 告警策略

| 场景                | 条件示例                                   | 处理                             |
|---------------------|--------------------------------------------|----------------------------------|
| 服务不可用          | `/health` 连续 3 次失败                    | PagerDuty/钉钉通知               |
| Celery 队列堆积     | `LLEN celery > 100` 持续 5 分钟            | 扩容 worker，排查任务是否卡住   |
| 任务失败率升高      | 过去 10 分钟 `failed / total > 20%`        | 记录异常任务 ID，触发排查流程   |
| 磁盘空间不足        | `data/traffic` 使用率 > 80%                | 自动归档或扩容                   |

---

## 4. Trace 与 Profiling（阶段 2）

- 可引入 OpenTelemetry，对关键接口打点
- 结合 Jaeger/Tempo 查看调用链
- 使用 PyInstrument/Chrome Performance 页面定位慢查询、慢接口

---

## 5. 落实顺序建议

1. Prometheus 抓取 `/metrics`，Grafana 展示
2. 日志发送到集中平台，配置简单查询面板
3. Alertmanager/钉钉告警打通
4. Trace/Profiling 视项目成长逐步添加

完成每个阶段后，请在本路线图中记录版本与时间点，保证团队知道当前监控能力。

