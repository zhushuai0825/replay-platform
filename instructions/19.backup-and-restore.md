# 19. 备份与恢复方案（详细指南）

## 1. 数据库备份
### 1.1 手动备份
```bash
cd backend
pg_dump -h localhost -U replay_user -F c -b -v -f backups/replay_db_$(date +%F).dump replay_db
```
说明：
- `-F c`：自定义格式，便于恢复
- `-b`：包含 large objects

### 1.2 自动脚本（示例 `scripts/database/backup_db.sh`）
```bash
#!/bin/bash
set -e
DATE=$(date +%F-%H%M)
mkdir -p backups
pg_dump -h localhost -U replay_user -F c replay_db > backups/replay_db_$DATE.dump
find backups -type f -mtime +7 -delete  # 保留7天
```

### 1.3 恢复
```bash
pg_restore -h localhost -U replay_user -d replay_db backups/replay_db_xxx.dump
```

## 2. 流量文件备份
- 使用 rclone/rsync 同步 `backend/data/traffic/` 到对象存储（MinIO/S3）：
  ```bash
  aws s3 sync backend/data/traffic s3://replay-platform-traffic/
  ```
- 可写脚本 `scripts/storage/sync_to_s3.sh`，配合 cron/CI 定时执行

## 3. 配置与密钥
- `.env`、配置文件存入密码管理工具（1Password、Bitwarden）或 Vault/Parameter Store
- 重要密钥（SECRET_KEY、DB 密码）不写入 Git

## 4. Celery 任务状态
- 如果需要持久化结果，将 `CELERY_RESULT_BACKEND` 指向 Postgres/Redis 并定期清理：
  ```python
  celery_app.conf.result_expires = 3600
  ```

## 5. 演练流程
1. 在测试环境执行备份脚本
2. 删除一部分数据或模拟故障
3. 执行恢复命令
4. 验证应用是否正常运行
