# 15. 日志与错误处理（详细指南）

## 1. 后端日志配置（`app/utils/logger.py`）
```python
from loguru import logger
import sys
from pathlib import Path

LOG_DIR = Path("logs")
LOG_DIR.mkdir(exist_ok=True)

logger.remove()
logger.add(sys.stdout, level="INFO", serialize=False)
logger.add(LOG_DIR / "app.log", level="INFO", rotation="1 day", retention="7 days", serialize=True)
```
在需要记录日志的模块：
```python
from app.utils.logger import logger
logger.info("Task created", task_id=task.id)
```

## 2. FastAPI 全局异常处理
```python
from fastapi import Request
from fastapi.responses import JSONResponse
from app.utils.logger import logger

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    logger.exception("Unhandled error", error=str(exc), path=request.url.path)
    return JSONResponse(status_code=500, content={"detail": "Internal Server Error"})
```

## 3. Celery 任务异常
```python
try:
    ...
except Exception as e:
    task.status = "failed"
    task.error_message = str(e)
    db.commit()
    logger.exception("Celery task failed", task_id=task_id, error=str(e))
    raise
```

## 4. 前端日志
- 全局错误捕获：
  ```javascript
  app.config.errorHandler = (err, instance, info) => {
    console.error("Vue error:", err, info)
    // 可上报到自建接口或 Sentry
  }
  window.addEventListener('error', (event) => {
    console.error('Global error', event.error)
  })
  ```
- axios 响应拦截器统一提示：
  ```javascript
  api.interceptors.response.use(
    (response) => response.data,
    (error) => {
      ElMessage.error(error.response?.data?.detail || '请求失败')
      return Promise.reject(error)
    }
  )
  ```

## 5. 日志字段建议
- trace_id/request_id（可用 uuid 每个请求生成）
- user_id、任务 ID、接口耗时、client_ip

## 6. 清理与归档
- loguru 的 `rotation`/`retention` 控制日志大小/保留时间
- 生产环境可将日志发送到 ELK、Loki、CloudWatch 等集中平台，便于检索
