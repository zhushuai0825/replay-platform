# 15. 日志与错误处理（当前状态）

> 项目已实现 loguru 日志和部分错误处理。尚未添加全局异常拦截、前端错误上报等内容，以下记录现状与 todo。

---

## 1. loguru 日志（已实现）

- `app/utils/logger.py` 中配置了 stdout + `logs/app.log`（JSON）
- `app/api/tasks.py`、`app/api/traffic.py`、`app/services/replay_engine.py` 中已经通过 `logger.info/exception` 记录关键事件
- 在 Docker 环境中，stdout 日志可直接被 `docker logs` 收集，文件日志可被 Promtail/ELK 使用

---

## 2. FastAPI/Celery 错误处理（部分）

- FastAPI 目前未注册全局异常处理器，错误会走默认 500 响应
- Celery 任务 `run_replay_task` 中已有 try/except，失败时会把任务状态改为 failed 并记录日志
- 建议后续添加：
  - 全局异常处理器（记录 `request.url.path`、trace_id 等）
  - 客户端友好的错误返回结构

---

## 3. 前端现状

- 目前只有 axios 响应拦截器打印错误，没有 UI 弹窗或上报
- 可在 `main.js` 中加入 `app.config.errorHandler` 和 `window.onerror`，并将错误上报到后端或日志平台

---

## 4. 建议的日志字段

- `trace_id` / `request_id`：可在中间件中生成并附加到日志
- `user_id`：等鉴权完成后再记录
- `task_id`、`traffic_file_id` 等业务标识
- 接口耗时、客户端 IP、User-Agent

---

## 5. 清理与聚合

- loguru 已启用 `rotation="1 day"`、`retention="7 days"`，确保日志不会无限增长
- 生产环境建议将 `logs/app.log` 交给 ELK/Loki/CloudWatch 等集中平台，便于检索与报警

---

## 6. 后续 todo

1. 编写 FastAPI 全局异常处理器（捕获未处理异常，返回统一结构）
2. 在前端加入统一的错误提示/上报
3. 引入 trace_id，串联日志、指标和请求
4. 为 Celery 任务增加更多上下文（执行耗时、失败原因、重试次数）
